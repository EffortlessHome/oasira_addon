# Stage 1: Build the oasira-dashboard
FROM node:20-alpine AS dashboard-build

WORKDIR /dashboard-src

# Copy dashboard package files
COPY ../oasira-dashboard/package*.json ./

# Install dependencies
RUN npm install

# Copy dashboard source files
COPY ../oasira-dashboard/ ./

# Build the Vite app
RUN npm run build

# Stage 2: Main addon image
FROM ghcr.io/home-assistant/aarch64-base:latest

RUN apk add --no-cache python3 py3-pip

COPY run.py /run.py
RUN chmod +x /run.py

COPY run.sh /run.sh
RUN chmod +x /run.sh

COPY cert.pem /root/.cloudflared/cert.pem
COPY cert.pem /cert.pem

# Copy the built dashboard files from stage 1
COPY --from=dashboard-build /dashboard-src/dist /var/www/dashboard

# Copy requirements and install Python packages
COPY requirements.txt /requirements.txt

# Create and use a virtual environment for Python packages
RUN python3 -m venv /venv \
    && . /venv/bin/activate \
    && pip install --no-cache-dir -r /requirements.txt \
    && pip install --no-cache-dir aiohttp websockets==12.0 Brotli

ENV PATH="/venv/bin:$PATH"

CMD ["/run.sh"]